<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>tor: libkeccak-tiny</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">tor
   &#160;<span id="projectnumber">master</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">libkeccak-tiny </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>An implementation of the FIPS-202-defined SHA-3 and SHAKE functions in 120 cloc (156 lines). One C file, one header.</p>
<p>The <code>Keccak-f[1600]</code> permutation is fully unrolled; it's nearly as fast as the Keccak team's optimized permutation.</p>
<h2>Building</h2>
<pre class="fragment">&gt; clang -O3 -march=native -std=c11 -Wextra -dynamic -shared keccak-tiny.c -o libkeccak-tiny.dylib
</pre><p>If you don't have a modern libc that includes the <code>memset_s</code> function, you can just add <code>-D"memset_s(W,WL,V,OL)=memset(W,V,OL)</code> to the command line.</p>
<h2>Using</h2>
<p>Build the library, include the header, and do, e.g., </p><pre class="fragment">shake256(out, 256, in, inlen);
</pre><p>That's it.</p>
<p>(Note: You can request less output from the fixed-output-length functions, but not more.)</p>
<h2>TweetShake</h2>
<p>The relevant tweets:</p>
<div class="fragment"><div class="line"><span class="comment">// @hashbreaker Inspired by TweetNaCl!</span></div><div class="line"><span class="comment">// Keccak and SHA-3 are supposedly hard to implement. So, how many tweets does it take to get to the center of a sponge...?</span></div><div class="line"><span class="preprocessor">#define decshake(bits) int shake##bits(unsigned char* o, unsigned long, unsigned char*, unsigned long);                   </span><span class="comment">/*begin keccak.h*/</span><span class="preprocessor"></span></div><div class="line"><span class="preprocessor">#define decsha3(bits) int sha3_##bits(unsigned char*,unsigned long,unsigned char*,unsigned long);</span></div><div class="line">decshake(128) decshake(256) decsha3(224) decsha3(256) decsha3(384) decsha3(512)                                             <span class="comment">/*end keccak.h*/</span></div><div class="line"><span class="preprocessor">#define K static const </span><span class="comment">/* Keccak constants: rho rotations, pi lanes, and iota RCs */</span><span class="preprocessor">                                      </span><span class="comment">/*begin keccak.c*/</span><span class="preprocessor"></span></div><div class="line"><span class="keyword">typedef</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> byte;<span class="keyword">typedef</span> byte*bytes;<span class="keyword">typedef</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> z;<span class="keyword">typedef</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> u8;K u8 <a class="code" href="config_8c.html#adacae73549bfbc6b27841ca32728f750">V</a>=1ULL&lt;&lt;63;K u8 W=1ULL&lt;&lt;31;</div><div class="line"><span class="preprocessor">#define V (1ULL&lt;&lt;63)</span></div><div class="line"><span class="preprocessor">#define W (1ULL&lt;31)</span></div><div class="line">K byte rho[24]={1,3,6,10,15,21,28,36,45,55,2,14,27,41,56,8,25,43,62,18,39,61,20,44};K u8 RC[24]={1,0x8082,V|0x808a,V|W|0x8000,0x808b,W|1,V|W</div><div class="line">|0x8081,V|0x8009,138,136,W|0x8009,W|10,W|0x808b,V|0x8b,V|0x8089,V|0x8003,V|0x8002,V|0x80,0x800a,V|W|0xa,V|W|0x8081,V|0x8080,W|1,V|W|0x8008};</div><div class="line">K byte pi[25]={10,7,11,17,18,3,5,16,8,21,24,4,15,23,19,13,12,2,20,14,22,9,6,1}; <span class="keyword">static</span> <span class="keyword">inline</span> z min(z a,z b){<span class="keywordflow">return</span> (a&lt;b)?a:b;}</div><div class="line"><span class="preprocessor">#define ROL(x, s) </span><span class="comment">/* rotary shift */</span><span class="preprocessor"> (((x) &lt;&lt; s) | ((x) &gt;&gt; (64-s)))              </span></div><div class="line"><span class="preprocessor">#define R24(e) </span><span class="comment">/* repeat 24 times */</span><span class="preprocessor"> e e e e e e e e e e e e e e e e e e e e e e e e</span></div><div class="line"><span class="preprocessor">#define L5(v,s,e) </span><span class="comment">/* 5-unroll a loop */</span><span class="preprocessor"> v=0; e; v+=s; e; v+=s; e; v+=s; e; v+=s; e; v+=s;                              </span></div><div class="line"><span class="preprocessor">static inline void keccakf(u8* a){u8 b[5]={0};u8 t=0;byte x,y,i=0; </span><span class="comment">/*24 rounds:*/</span><span class="preprocessor">R24( L5(x,1,b[x]=0;L5(y,5, </span><span class="comment">/*parity*/</span><span class="preprocessor"> b[x] ^= a[x+y]))</span></div><div class="line">L5(x,1,L5(y,5,<span class="comment">/*theta*/</span>a[y+x] ^= b[(x+4)%5] ^ ROL(b[(x+1)%5],1))) t=a[1];x=0;R24(b[0]=a[pi[x]];<span class="comment">/*rho*/</span>a[pi[x]]=ROL(t, rho[x]);t=b[0];x++;)</div><div class="line">L5(y,5,L5(x,1, <span class="comment">/*chi*/</span> b[x] = a[y+x]) L5(x,1, a[y+x] = b[x] ^ ~b[(x+1)%5] &amp; b[(x+2)%5])) <span class="comment">/*iota*/</span> a[0] ^= RC[i]; i++; )}     </div><div class="line"><span class="preprocessor">#define FOR(i, ST, L, S) </span><span class="comment">/*obvious*/</span><span class="preprocessor"> do { for (z i = 0; i &lt; L; i += ST) { S; } } while (0)   </span></div><div class="line"><span class="preprocessor">#define appl(NAME, S) </span><span class="comment">/*macro to define array comprehensions*/</span><span class="preprocessor"> static inline void NAME(bytes dst, bytes src, z len) { FOR(i, 1, len, S); }</span></div><div class="line"><span class="comment">/*helpers:*/</span> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> clear(bytes a) { FOR(i,1,200,a[i]=0); } appl(xorin, dst[i] ^= src[i])  appl(<span class="keyword">set</span>, src[i] = dst[i])</div><div class="line"><span class="preprocessor">#define foldP(I, L, F) </span><span class="comment">/* macro to fold app P F */</span><span class="preprocessor"> while (L &gt;= r) { </span><span class="comment">/*apply F*/</span><span class="preprocessor"> F(a, I, r); </span><span class="comment">/*permute*/</span><span class="preprocessor"> keccakf(A); I += r; L -= r; }</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> hash(bytes o,z olen,bytes in,z ilen,z r,byte D){ <span class="keywordflow">if</span>((o == (<span class="keywordtype">void</span>*)0)||((in == (<span class="keywordtype">void</span>*)0)&amp;&amp;ilen != 0)||(r &gt;= 200))<span class="keywordflow">return</span> -1;</div><div class="line"><span class="comment">/*absorb*/</span>u8 A[25]={0};bytes a=(bytes)A;<span class="comment">/*full blocks*/</span>foldP(in,ilen,xorin);<span class="comment">/*last block*/</span>xorin(a,in,ilen);a[ilen]^=D;</div><div class="line"><span class="comment">/*padend:*/</span>a[r-1]^=0x80; keccakf(A); foldP(o,olen,<span class="keyword">set</span>);<span class="comment">/*last bytes*/</span><span class="keyword">set</span>(a,o,olen);<span class="comment">/*done!*/</span>clear(a);<span class="keywordflow">return</span> 0;}</div><div class="line"><span class="preprocessor">#define defshake(bits) int shake##bits(bytes o, z olen, bytes in, z ilen) {return hash(o,olen,in,ilen,200-(bits/4),0x1f);}</span></div><div class="line"><span class="preprocessor">#define defsha3(bits) int sha3_##bits(bytes o,z olen,bytes in,z ilen) {return hash(o,min(olen,200-(bits/4)),in,ilen,200-(bits/4),0x06);}</span></div><div class="line"><span class="comment">/*define the SHA3 and SHAKE instances:*/</span>defshake(128) defshake(256) defsha3(224) defsha3(256) defsha3(384) defsha3(512)<span class="comment">/*end keccak.c*/</span></div><div class="line"><span class="comment">// ...chomp. 24 kinda legible tweets (3232 bytes). And a simple interface: shake256(digest, digestlen, in, inlen)</span></div><div class="line"><span class="comment">// Clang recommended. GCC users will need to insert &quot;#define V (1ULL&lt;&lt;63)&quot; and &quot;#define W (1ULL&lt;31)&quot; at the point marked &quot;/*!gcc*/&quot;</span></div><div class="line"><span class="comment">// If you&#39;re using as a prefix MAC, you MUST replace the body of &quot;clear&quot; with &quot;memset_s(a, 200, 0, 200)&quot; to avoid misoptimization.</span></div><div class="line"><span class="comment">// @everyone_who_is_still_using_sha1 Please stop using SHA-1.</span></div><div class="line"><span class="comment">// Oh, one more thing: a C11-threaded, memmapped shake256sum in 10 tweets. (Your libc may need a shim for C11 thread support.)</span></div><div class="line"><span class="comment">// echo -n string stdio stdint fcntl sys/mman sys/stat sys/types unistd threads|tr &#39; &#39; \\n|xargs -n1 -I_ echo &#39;#include &lt;_.h&gt;&#39;</span></div><div class="line"><span class="preprocessor">#include &quot;kcksum_tweet.h&quot;</span></div><div class="line"><span class="preprocessor">#define E(LABEL, MSG) if (err != 0) { strerror_r(err, serr, 1024); fprintf(stderr, &quot;%s: &#39;%s&#39; %s\n&quot;, serr, fn, MSG); goto LABEL;}</span></div><div class="line"><span class="keyword">static</span> mtx_t iomtx;<span class="keywordtype">void</span> h(<span class="keywordtype">void</span>* v);<span class="keywordtype">void</span> h(<span class="keywordtype">void</span>* v){<span class="keywordtype">char</span>* fn=(<span class="keywordtype">char</span>*)v;<span class="keywordtype">int</span> err=0;<span class="keywordtype">char</span> serr[1024]={0};<span class="comment">/*open file*/</span><span class="keywordtype">int</span> fd=open(fn, O_RDONLY);</div><div class="line">err=!fd;E(ret,<span class="stringliteral">&quot;couldn&#39;t be opened.&quot;</span>);<span class="comment">/*stat it*/</span><span class="keyword">struct </span>stat stat;err=fstat(fd,&amp;stat);E(close,<span class="stringliteral">&quot;doesn&#39;t exist.&quot;</span>);err=!!(stat.st_mode&amp;S_IFDIR);</div><div class="line">E(close,<span class="stringliteral">&quot;not a regular file.&quot;</span>);z length=(size_t)stat.st_size;<span class="comment">/*mmap the file*/</span>bytes in=length?mmap(0,length,PROT_READ,MAP_SHARED,fd,0):NULL;</div><div class="line"><span class="keywordflow">if</span>(length&amp;&amp;(in==MAP_FAILED)){E(close,<span class="stringliteral">&quot;mmap-ing failed.&quot;</span>);}byte out[64]={0};<span class="comment">/*hash it*/</span>shake256(out,64,in,length);length&amp;&amp;munmap(in,length);</div><div class="line"><span class="comment">/*lock io*/</span>mtx_lock(&amp;iomtx);printf(<span class="stringliteral">&quot;SHAKE256(&#39;%s&#39;) = &quot;</span>, fn);FOR(i,1,64,printf(<span class="stringliteral">&quot;%02x&quot;</span>,out[i]));printf(<span class="stringliteral">&quot;\n&quot;</span>);mtx_unlock(&amp;iomtx);<span class="comment">/*unlock io*/</span></div><div class="line">close:close(fd);ret:thrd_exit(err);}<span class="keywordtype">int</span> <a class="code" href="tor__main_8c.html#a0ddf1224851353fc92bfbff6f499fa97">main</a>(<span class="keywordtype">int</span> argc,<span class="keywordtype">char</span>** argv){<span class="keywordtype">int</span> err=0; mtx_init(&amp;iomtx, mtx_plain); thrd_t t[4]; <span class="keywordtype">int</span> res[4],i,j,k;</div><div class="line"><span class="keywordflow">for</span>(i=1;i&lt;argc;i+=4){<span class="keywordflow">for</span>(j=0;j&lt;4;j++){<span class="keywordflow">if</span>((j+i)==argc){<span class="comment">/*out of files*/</span><span class="keywordflow">goto</span> join;} <span class="comment">/*spawn*/</span> thrd_create(t + j,h,argv[i + j]);}</div><div class="line">join: <span class="keywordflow">for</span> (k = 0; k &lt; j; k++) { <span class="comment">/*wait*/</span> err |= thrd_join(t[k], res + k); err |= res[k];} } mtx_destroy(&amp;iomtx); <span class="keywordflow">return</span> err; } <span class="comment">/* done! */</span></div></div><!-- fragment --><h2>License</h2>
<p><a href="http://creativecommons.org/publicdomain/zero/1.0/">CC0</a> </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
