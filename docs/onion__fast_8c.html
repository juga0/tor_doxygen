<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>tor: /home/user/_my/code/bwauth-related/tor/src/or/onion_fast.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">tor
   &#160;<span id="projectnumber">master</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_97b64286d42c5ef1697cb5f17129db19.html">tor</a></li><li class="navelem"><a class="el" href="dir_3cb0ba3f4b82dbe34a1a06276e96bc8d.html">src</a></li><li class="navelem"><a class="el" href="dir_386635fabd7f6c74e9d9c7a8604514a0.html">or</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">onion_fast.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>Functions implement the CREATE_FAST circuit handshake.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &quot;<a class="el" href="or_8h_source.html">or.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="onion__fast_8h_source.html">onion_fast.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="crypto__rand_8h_source.html">crypto_rand.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="crypto__util_8h_source.html">crypto_util.h</a>&quot;</code><br />
</div><div class="textblock"><div class="dynheader">
Include dependency graph for onion_fast.c:</div>
<div class="dyncontent">
<div class="center"><img src="onion__fast_8c__incl.png" border="0" usemap="#_2home_2user_2__my_2code_2bwauth-related_2tor_2src_2or_2onion__fast_8c" alt=""/></div>
<map name="_2home_2user_2__my_2code_2bwauth-related_2tor_2src_2or_2onion__fast_8c" id="_2home_2user_2__my_2code_2bwauth-related_2tor_2src_2or_2onion__fast_8c">
<area shape="rect" id="node2" href="or_8h.html" title="Master header file for Tor&#45;specific functionality. " alt="" coords="1513,109,1557,136"/>
<area shape="rect" id="node41" href="onion__fast_8h.html" title="Header file for onion_fast.c. " alt="" coords="2493,109,2587,136"/>
<area shape="rect" id="node42" href="crypto__rand_8h.html" title="Common functions for using (pseudo&#45;)random number generators. " alt="" coords="2195,483,2296,509"/>
<area shape="rect" id="node43" href="crypto__util_8h.html" title="Common functions for cryptographic routines. " alt="" coords="2245,707,2339,733"/>
<area shape="rect" id="node3" href="orconfig_8h_source.html" title="orconfig.h" alt="" coords="901,931,979,957"/>
<area shape="rect" id="node4" href="torint_8h.html" title="Header file to define uint32_t and friends. " alt="" coords="1737,856,1799,883"/>
<area shape="rect" id="node6" href="crypto_8h.html" title="Headers for crypto.c. " alt="" coords="232,259,301,285"/>
<area shape="rect" id="node20" href="container_8h_source.html" title="container.h" alt="" coords="1377,483,1463,509"/>
<area shape="rect" id="node22" href="torlog_8h.html" title="Headers for log.c. " alt="" coords="313,557,378,584"/>
<area shape="rect" id="node23" href="crypto__format_8h_source.html" title="crypto_format.h" alt="" coords="1803,184,1917,211"/>
<area shape="rect" id="node24" href="crypto__ed25519_8h_source.html" title="crypto_ed25519.h" alt="" coords="1683,259,1808,285"/>
<area shape="rect" id="node25" href="crypto__curve25519_8h_source.html" title="crypto_curve25519.h" alt="" coords="1447,333,1590,360"/>
<area shape="rect" id="node28" href="tortls_8h.html" title="Headers for tortls.c. " alt="" coords="798,259,861,285"/>
<area shape="rect" id="node31" href="compress_8h.html" title="Headers for compress.c. " alt="" coords="1239,184,1329,211"/>
<area shape="rect" id="node32" href="address_8h.html" title="Headers for address.h. " alt="" coords="1939,408,2018,435"/>
<area shape="rect" id="node33" href="compat__libevent_8h_source.html" title="compat_libevent.h" alt="" coords="5,781,133,808"/>
<area shape="rect" id="node34" href="ht_8h_source.html" title="ht.h" alt="" coords="1354,184,1398,211"/>
<area shape="rect" id="node35" href="confline_8h_source.html" title="confline.h" alt="" coords="1138,259,1217,285"/>
<area shape="rect" id="node36" href="replaycache_8h.html" title="Header file for replaycache.c. " alt="" coords="1422,184,1525,211"/>
<area shape="rect" id="node37" href="tor__queue_8h_source.html" title="tor_queue.h" alt="" coords="1549,184,1640,211"/>
<area shape="rect" id="node38" href="token__bucket_8h_source.html" title="token_bucket.h" alt="" coords="1907,781,2018,808"/>
<area shape="rect" id="node39" href="util__format_8h_source.html" title="util_format.h" alt="" coords="1585,781,1679,808"/>
<area shape="rect" id="node40" href="hs__circuitmap_8h.html" title="Header file for hs_circuitmap.c. " alt="" coords="1664,184,1779,211"/>
<area shape="rect" id="node8" href="compat_8h_source.html" title="compat.h" alt="" coords="614,707,690,733"/>
<area shape="rect" id="node14" href="util_8h.html" title="Headers for util.c. " alt="" coords="1184,557,1235,584"/>
<area shape="rect" id="node18" href="crypto__rsa_8h.html" title="Headers for crypto_rsa.c. " alt="" coords="503,333,598,360"/>
<area shape="rect" id="node9" href="testsupport_8h_source.html" title="testsupport.h" alt="" coords="1331,856,1429,883"/>
<area shape="rect" id="node11" href="compat__time_8h.html" title="Functions and types for monotonic times. " alt="" coords="278,856,386,883"/>
<area shape="rect" id="node13" href="compat__threads_8h_source.html" title="compat_threads.h" alt="" coords="462,781,589,808"/>
<area shape="rect" id="node15" href="di__ops_8h.html" title="Headers for di_ops.c. " alt="" coords="1185,781,1255,808"/>
<area shape="rect" id="node17" href="util__bug_8h.html" title="Macros to manage assertions, fatal and non&#45;fatal. " alt="" coords="1209,632,1287,659"/>
<area shape="rect" id="node19" href="crypto__digest_8h.html" title="Headers for crypto_digest.c. " alt="" coords="1251,408,1362,435"/>
<area shape="rect" id="node21" href="siphash_8h_source.html" title="siphash.h" alt="" coords="1381,557,1459,584"/>
<area shape="rect" id="node26" href="crypto__openssl__mgt_8h_source.html" title="crypto_openssl_mgt.h" alt="" coords="1077,408,1227,435"/>
<area shape="rect" id="node29" href="compat__openssl_8h.html" title="compatibility definitions for working with different openssl forks " alt="" coords="921,333,1049,360"/>
</map>
</div>
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a75edb2d6afec1a282cec8acd2094fd1c"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="onion__fast_8c.html#a75edb2d6afec1a282cec8acd2094fd1c">fast_handshake_state_free_</a> (<a class="el" href="structfast__handshake__state__t.html">fast_handshake_state_t</a> *victim)</td></tr>
<tr class="separator:a75edb2d6afec1a282cec8acd2094fd1c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af1f356217f5a81498c68010fa8cb0a6f"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="onion__fast_8c.html#af1f356217f5a81498c68010fa8cb0a6f">fast_onionskin_create</a> (<a class="el" href="structfast__handshake__state__t.html">fast_handshake_state_t</a> **handshake_state_out, uint8_t *handshake_out)</td></tr>
<tr class="separator:af1f356217f5a81498c68010fa8cb0a6f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9f51a042db19eac7047ee3e1d8000330"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="onion__fast_8c.html#a9f51a042db19eac7047ee3e1d8000330">fast_server_handshake</a> (const uint8_t *key_in, uint8_t *handshake_reply_out, uint8_t *key_out, size_t key_out_len)</td></tr>
<tr class="separator:a9f51a042db19eac7047ee3e1d8000330"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9ba1cfee4a2c8340f584c14b03042bb0"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="onion__fast_8c.html#a9ba1cfee4a2c8340f584c14b03042bb0">fast_client_handshake</a> (const <a class="el" href="structfast__handshake__state__t.html">fast_handshake_state_t</a> *handshake_state, const uint8_t *handshake_reply_out, uint8_t *key_out, size_t key_out_len, const char **msg_out)</td></tr>
<tr class="separator:a9ba1cfee4a2c8340f584c14b03042bb0"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Functions implement the CREATE_FAST circuit handshake. </p>
<p>The "CREATE_FAST" handshake is an unauthenticated, non-forward-secure key derivation mechanism based on SHA1. We used to use it for the first hop of each circuit, since the TAP handshake provided no additional security beyond the security already provided by the TLS handshake [*].</p>
<p>When we switched to ntor, we deprecated CREATE_FAST, since ntor is stronger than our TLS handshake was, and fast enough to not be worrisome.</p>
<p>This handshake, like the other circuit-extension handshakes, is invoked from <a class="el" href="onion_8c.html" title="Functions to queue create cells, wrap the various onionskin types, and parse and create the CREATE ce...">onion.c</a>.</p>
<p>[*]Actually, it's possible that TAP <em>was</em> a little better than TLS with RSA1024 certificates and EDH1024 for forward secrecy, if you hypothesize an adversary who can compute discrete logarithms on a small number of targeted DH1024 fields, but who can't break all that many RSA1024 keys. </p>
</div><h2 class="groupheader">Function Documentation</h2>
<a id="a9ba1cfee4a2c8340f584c14b03042bb0"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a9ba1cfee4a2c8340f584c14b03042bb0">&#9670;&nbsp;</a></span>fast_client_handshake()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int fast_client_handshake </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="structfast__handshake__state__t.html">fast_handshake_state_t</a> *&#160;</td>
          <td class="paramname"><em>handshake_state</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const uint8_t *&#160;</td>
          <td class="paramname"><em>handshake_reply_out</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint8_t *&#160;</td>
          <td class="paramname"><em>key_out</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t&#160;</td>
          <td class="paramname"><em>key_out_len</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char **&#160;</td>
          <td class="paramname"><em>msg_out</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Implement the second half of the client side of the CREATE_FAST handshake. We sent the server <b>handshake_state</b> ("x") already, and the server told us <b>handshake_reply_out</b> (y|H(x|y)). Make sure that the hash is correct, and generate key material in <b>key_out</b>. Return 0 on success, true on failure.</p>
<p>NOTE: The "CREATE_FAST" handshake path is distinguishable from regular "onionskin" handshakes, and is not secure if an adversary can see or modify the messages. Therefore, it should only be used by clients, and only as the first hop of a circuit (since the first hop is already authenticated and protected by TLS). </p>

</div>
</div>
<a id="a75edb2d6afec1a282cec8acd2094fd1c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a75edb2d6afec1a282cec8acd2094fd1c">&#9670;&nbsp;</a></span>fast_handshake_state_free_()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void fast_handshake_state_free_ </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structfast__handshake__state__t.html">fast_handshake_state_t</a> *&#160;</td>
          <td class="paramname"><em>victim</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Release all state held in <b>victim</b>. </p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="onion__fast_8c_a75edb2d6afec1a282cec8acd2094fd1c_cgraph.png" border="0" usemap="#onion__fast_8c_a75edb2d6afec1a282cec8acd2094fd1c_cgraph" alt=""/></div>
<map name="onion__fast_8c_a75edb2d6afec1a282cec8acd2094fd1c_cgraph" id="onion__fast_8c_a75edb2d6afec1a282cec8acd2094fd1c_cgraph">
<area shape="rect" id="node2" href="crypto__util_8c.html#a955f8d276e5213dd68600bf6dee0b9ae" title="memwipe" alt="" coords="204,13,283,39"/>
</map>
</div>

</div>
</div>
<a id="af1f356217f5a81498c68010fa8cb0a6f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af1f356217f5a81498c68010fa8cb0a6f">&#9670;&nbsp;</a></span>fast_onionskin_create()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int fast_onionskin_create </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structfast__handshake__state__t.html">fast_handshake_state_t</a> **&#160;</td>
          <td class="paramname"><em>handshake_state_out</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint8_t *&#160;</td>
          <td class="paramname"><em>handshake_out</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Create the state needed to perform a CREATE_FAST handshake. Return 0 on success, -1 on failure. </p>

</div>
</div>
<a id="a9f51a042db19eac7047ee3e1d8000330"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a9f51a042db19eac7047ee3e1d8000330">&#9670;&nbsp;</a></span>fast_server_handshake()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int fast_server_handshake </td>
          <td>(</td>
          <td class="paramtype">const uint8_t *&#160;</td>
          <td class="paramname"><em>key_in</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint8_t *&#160;</td>
          <td class="paramname"><em>handshake_reply_out</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint8_t *&#160;</td>
          <td class="paramname"><em>key_out</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t&#160;</td>
          <td class="paramname"><em>key_out_len</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Implement the server side of the CREATE_FAST abbreviated handshake. The client has provided DIGEST_LEN key bytes in <b>key_in</b> ("x"). We generate a reply of DIGEST_LEN*2 bytes in <b>key_out</b>, consisting of a new random "y", followed by H(x|y) to check for correctness. We set <b>key_out_len</b> bytes of key material in <b>key_out</b>. Return 0 on success, &lt;0 on failure. </p>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
